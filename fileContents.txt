app.py:
from flask import Flask, render_template, request, redirect, url_for
from pymongo.mongo_client import MongoClient
from pymongo.server_api import ServerApi
from gtts import gTTS
import io
import base64

import os
from dotenv import load_dotenv

# Custom modules
import PostHandler

load_dotenv()


app = Flask(__name__)

# Testing Parameters
REAL_DATA = False            # ? False: use sample data / True: use real data
TEST_CONNECTION = False     # ? False: don't test connection / True: test connection


# Define db and collection as placeholders
db = None
collection = None

if REAL_DATA:
    # MongoDB connection
    mongodb_uri = os.getenv("MONGODB_URI")
    client = MongoClient(mongodb_uri, server_api=ServerApi('1'))

    # Select the database and collection
    db = client['DTL_db']
    collection = db['posts']

    # Send a ping to confirm a successful connection
    if TEST_CONNECTION:
        try:
            client.admin.command('ping')
            print("✅ Pinged your deployment. You successfully connected to MongoDB!")
        except Exception as e:
            print(e)

        # Add a sample document in the collection (don't add if already exists)
        name = 'John Doe'
        if collection.count_documents({'name': name}) == 0:
            collection.insert_one({'name': name})
            print("✅ Added a sample document in the collection.")

        # Retrieve the sample document added
        result = collection.find_one({'name': name})
        print(result)
        print("✅ Retrieved the sample document.")

        # Delete the sample document added
        collection.delete_one({'name': name})
        print("✅ Deleted the sample document.")


@app.route('/')
def index():

    posts_dict = PostHandler.getPostsData(collection, REAL_DATA)

    return render_template('dashboard.html', posts_dict=posts_dict)


@app.route('/dashboard')
def dashboard():
    return render_template('dashboard.html')


@app.route('/events')
def events():
    return render_template('events.html')


@app.route('/events/all_in_one/<category>')
def all_in_one(category):

    # category = upcoming/ongoing/completed

    posts_dict = PostHandler.getPostsData(collection, REAL_DATA)
    return render_template('all_in_one.html', posts_dict=posts_dict, category=category)


@app.route('/eventDetail')
def eventDetail():

    # Get the event details from the URL

    title = request.args.get('title')
    date = request.args.get('date')
    des = request.args.get('des')
    image = request.args.get('image')
    host = request.args.get('host')

    return render_template('eventDetails.html', title=title, date=date, des=des, image=image, host=host)


@app.route('/clubs')
def clubs_page():
    return render_template('clubs.html')


@app.route('/clubs/all_in_one_clubs/<category>')
def all_in_one_clubs(category):

    posts_dict = PostHandler.getPostsDataClubs(collection, REAL_DATA)
    return render_template('all_in_one_clubs.html', posts_dict=posts_dict, category=category)


@app.route('/clubDetails')
def clubDetails():

    # Get the event details from the URL

    name = request.args.get('name')
    posts_dict = PostHandler.getPostsDataClubs(collection, REAL_DATA)
    return render_template('clubDetails.html', name=name, posts_dict=posts_dict)


# Chatbot functions
def getSpeech(result_text):

    language = 'en'
    speech = gTTS(text=result_text, lang=language, slow=False)

    # On local machine
    # speech.save("speech.mp3")
    # os.system("start speech.mp3")

    # Save the speech to memory as bytes
    speech_file = io.BytesIO()
    speech.write_to_fp(speech_file)
    speech_bytes = speech_file.getvalue()
    speech_base64 = base64.b64encode(speech_bytes).decode('utf-8')

    return speech_base64


def getChatbotResponse(user_input):

    # Default values
    response_text = "Sorry, I don't understand. Please try again."
    redirect_link = None

    if user_input == "See upcoming events":
        response_text = "You chose option 1: See upcoming events."
        redirect_link = url_for('all_in_one', category='upcoming')
        redirect_text = "View upcoming events"
    elif user_input == "See ongoing events":
        response_text = "You chose option 2: See ongoing events."
        redirect_link = url_for('all_in_one', category='ongoing')
        redirect_text = "View ongoing events"
    elif user_input == "See completed events":
        response_text = "You chose option 3: See completed events."
        redirect_link = url_for('all_in_one', category='completed')
        redirect_text = "View completed events"
    elif user_input == "Visit the events page":
        response_text = "You chose option 4: Visit the events page."
        redirect_link = url_for('events')
        redirect_text = "Visit the events page"
    elif user_input == "Visit the official RVCE website":
        response_text = "You chose option 5: Visit the official RVCE website."
        redirect_link = "https://www.rvce.edu.in/"
        redirect_text = "Visit the official RVCE website"
    elif user_input == "Get Placement Statistics":
        response_text = "You chose option 6: Get Placement Statistics."
        redirect_link = "https://rvce.edu.in/placement-statistics"
        redirect_text = "Get Placement Statistics"

    audio_text = f"""{response_text} Click the link below to proceed to your chosen option.
    If you would like to choose another option, please select it from the dropdown menu given above."""

    response_audio = getSpeech(audio_text)

    return response_text, redirect_link, redirect_text, response_audio


@app.route('/chatbot', methods=['GET', 'POST'])
def chatbot():

    # Question : Options dictionary
    questionnaire = {"What would you like to do?": ["See upcoming events",
                                                    "See ongoing events",
                                                    "See completed events",
                                                    "Visit the events page",
                                                    "Visit the official RVCE website",
                                                    "Get Placement Statistics"
                                                    ]}

    hello = "Hello, I am the DTL Chatbot of RVCE. How can I help you today?"
    speech_base64 = getSpeech(hello)

    if request.method == 'POST':
        user_input = request.form['user_input']
        response_text, redirect_link, redirect_text, response_audio = getChatbotResponse(
            user_input)

        return render_template('chatbot.html', questionnaire=questionnaire,
                               user_input=user_input, response_text=response_text,
                               redirect_link=redirect_link, redirect_text=redirect_text,
                               response_audio=response_audio)

    return render_template('chatbot.html', questionnaire=questionnaire, speech_base64=speech_base64)


if __name__ == '__main__':
    app.run(debug=True)


PostHandler.py:
import json
from datetime import datetime, date


def formatData(posts_dict):

    today = date.today()

    for post in posts_dict:
        # Convert date from string to datetime object
        post['date'] = datetime.strptime(post['date'], '%Y-%m-%d')

        # Convert date to string in the format DD MMM YYYY
        post['date_str'] = post['date'].strftime('%d %b %Y')

        # Categorize the post\
        if post['date'].date() > today:
            post['category'] = 'Upcoming'
        elif post['date'].date() == today:
            post['category'] = 'Ongoing'
        else:
            post['category'] = 'Completed'

    # Sort posts by date (Newest first)
    posts_dict = sorted(posts_dict, key=lambda k: k['date'])

    return posts_dict


def getPostsData(collection, REAL_DATA):

    posts_dict = []

    # Get data from MongoDB afterwards
    if REAL_DATA:
        posts_dict = list(collection.find({}))

    # Sample data
    else:
        with open('./static/json/sample_posts.json', 'r') as file:
            data = json.load(file)
            posts_dict = data['posts']

    posts_dict = formatData(posts_dict)

    return posts_dict


def getPostsDataClubs(collection, REAL_DATA):

    posts_dict = []

    # Get data from MongoDB afterwards
    if REAL_DATA:
        posts_dict = list(collection.find({}))

    # Sample data
    else:
        with open('./static/json/clubs.json', 'r') as file:
            data = json.load(file)
            posts_dict = data['posts']

    return posts_dict


templates/dashboard.html:
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='styles/dashboard.css') }}"
    />
  </head>

  <body>
    <!-- Navbar -->
    <nav>
      <a href="{{ url_for('events') }}"> <button>Events</button></a>
      <a href="{{ url_for('chatbot') }}"><button>Chatbot</button></a>
      <a href="{{ url_for('clubs_page') }}"><button>Clubs</button></a>
      <button>Home</button>
      <button>Login</button>
      <button>Timeline</button>
      <!-- Admin Page Link-->
      <!-- Only after login -->
      <button>Admin</button>
    </nav>

    <!-- Carousel -->
    <section>
      <div>
        <!-- Carousel here -->
        <p>Placeholder for carousel</p>
      </div>
    </section>

    <!-- Brief intro to our webpage/subdomain -->
    <section>
      <div>
        <p>
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Eligendi
          voluptas, incidunt accusantium neque corporis voluptatem laborum error
          a quas rem maxime consequuntur voluptatibus sequi quisquam enim fuga
          perspiciatis natus. Incidunt.
        </p>
      </div>
    </section>

    <!-- Grid section -->
    <section>
      <!-- Grid goes here -->
      <div>
        <h2>Clubs</h2>
        <!-- Club boxes -->
        <h2>Departments</h2>
        <!-- Department boxes-->
      </div>
    </section>

    <!-- Footer -->
    <section>
      <div>
        <!-- RV footer here -->
        <p>Footer</p>
      </div>
    </section>
  </body>
</html>


templates/chatbot.html:
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot</title>

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='styles/chatbot.css') }}"
    />
  </head>

  <body class="chatbot-bckg">
    <!-- Chatbot section -->
    <section class="chatbot">
      <!-- <h2>Chatbot</h2> -->

      <img src="../static/images/chat-bot-img.png" alt="" />

      <!-- Use hidden to hide the audio container -->
      <audio controls autoplay hidden>
        <source
          src="data:audio/mpeg;base64,{{ speech_base64 }}"
          type="audio/mpeg"
        />
        Your browser does not support the audio element.
      </audio>

      <!-- Form -->
      <form method="POST" action="/chatbot">
        <label for="user_input"
          >Hello, I am the DTL Chatbot. How can I help you today?</label
        >
        <select name="user_input" id="user_input">
          {% for question, choices in questionnaire.items() %}
          <option value="{{ question }}" disabled selected>
            {{ question }}
          </option>
          {% for choice in choices %}
          <option value="{{ choice }}">{{ choice }}</option>
          {% endfor %} {% endfor %}
        </select>
        <button type="submit">Get Assistance</button>
      </form>

      <!-- Display user input and bot response -->
      {% if user_input %}
      <div class="conversation">
        <div class="user-message">
          <p>You: {{ user_input }}</p>
        </div>

        <div class="bot-message">
          <!-- Use hidden to hide the audio container -->
          <audio controls autoplay hidden>
            <source
              src="data:audio/mpeg;base64,{{ response_audio }}"
              type="audio/mpeg"
            />
            Your browser does not support the audio element.
          </audio>
          <p>Bot Message: {{ response_text }}</p>
          {% if redirect_link %}
          <a target="_blank" href="{{ redirect_link }}">{{redirect_text}}</a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </section>
  </body>
</html>


