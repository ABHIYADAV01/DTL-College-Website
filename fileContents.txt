app.py:
from flask import Flask, render_template, request, redirect, url_for
from pymongo.mongo_client import MongoClient
from pymongo.server_api import ServerApi
from gtts import gTTS
import io
import base64

import os
from dotenv import load_dotenv

# Custom modules
import PostHandler

load_dotenv()


app = Flask(__name__)

# Testing Parameters
TEST_CONNECTION = False     # ? Set to True to test connection to MongoDB
REAL_DATA = False            # ? Set to False to use sample data


# MongoDB connection
mongodb_uri = os.getenv("MONGODB_URI")
client = MongoClient(mongodb_uri, server_api=ServerApi('1'))

# Select the database and collection
db = client['DTL_db']
collection = db['posts']

# Send a ping to confirm a successful connection
if TEST_CONNECTION:
    try:
        client.admin.command('ping')
        print("✅ Pinged your deployment. You successfully connected to MongoDB!")
    except Exception as e:
        print(e)

    # Add a sample document in the collection (don't add if already exists)
    name = 'John Doe'
    if collection.count_documents({'name': name}) == 0:
        collection.insert_one({'name': name})
        print("✅ Added a sample document in the collection.")

    # Retrieve the sample document added
    result = collection.find_one({'name': name})
    print(result)
    print("✅ Retrieved the sample document.")

    # Delete the sample document added
    collection.delete_one({'name': name})
    print("✅ Deleted the sample document.")


@app.route('/')
def index():

    posts_dict = PostHandler.getPostsData(collection, REAL_DATA)

    return render_template('dashboard.html', posts_dict=posts_dict)


@app.route('/dashboard')
def dashboard():
    return render_template('dashboard.html')


@app.route('/events')
def events():
    return render_template('events.html')


@app.route('/events/all_in_one/<category>')
def all_in_one(category):

    # category = upcoming/ongoing/completed

    posts_dict = PostHandler.getPostsData(collection, REAL_DATA)
    return render_template('all_in_one.html', posts_dict=posts_dict, category=category)


@app.route('/eventDetail')
def eventDetail():

    # Get the event details from the URL

    title = request.args.get('title')
    date = request.args.get('date')
    des = request.args.get('des')
    image = request.args.get('image')
    host = request.args.get('host')

    return render_template('eventDetails.html', title=title, date=date, des=des, image=image, host=host)


# Chatbot functions
def getSpeech(result_text):

    language = 'en'
    speech = gTTS(text=result_text, lang=language, slow=False)

    # On local machine
    # speech.save("speech.mp3")
    # os.system("start speech.mp3")

    # Save the speech to memory as bytes
    speech_file = io.BytesIO()
    speech.write_to_fp(speech_file)
    speech_bytes = speech_file.getvalue()
    speech_base64 = base64.b64encode(speech_bytes).decode('utf-8')

    return speech_base64


def getChatbotResponse(user_input):

    # Default values
    response_text = "Sorry, I don't understand. Please try again."
    redirect_link = None

    if user_input == "See upcoming events":
        response_text = "You chose option 1: See upcoming events."
        redirect_link = url_for('all_in_one', category='upcoming')
        redirect_text = "View upcoming events"
    elif user_input == "See completed events":
        response_text = "You chose option 2: See completed events."
        redirect_link = url_for('all_in_one', category='completed')
        redirect_text = "View completed events"
    elif user_input == "Visit the events page":
        response_text = "You chose option 3: Visit the events page."
        redirect_link = url_for('events')
        redirect_text = "Visit the events page"

    audio_text = f"{response_text} Click the link below to proceed to your chosen option."

    response_audio = getSpeech(audio_text)

    return response_text, redirect_link, redirect_text, response_audio


@app.route('/chatbot', methods=['GET', 'POST'])
def chatbot():

    # Question : Options dictionary
    questionnaire = {"What would you like to do?": ["See upcoming events",
                                                    "See completed events",
                                                    "Visit the events page"]}

    hello = "Hello, I am the DTL Chatbot of RVCE. How can I help you today?"
    speech_base64 = getSpeech(hello)

    if request.method == 'POST':
        user_input = request.form['user_input']
        response_text, redirect_link, redirect_text, response_audio = getChatbotResponse(
            user_input)

        return render_template('chatbot.html', questionnaire=questionnaire,
                               user_input=user_input, response_text=response_text,
                               redirect_link=redirect_link, redirect_text=redirect_text,
                               response_audio=response_audio)

    return render_template('chatbot.html', questionnaire=questionnaire, speech_base64=speech_base64)


if __name__ == '__main__':
    app.run(debug=True)


templates/dashboard.html:
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='styles/dashboard.css') }}"
    />
  </head>

  <body>
    <!-- Navbar -->
    <nav>
      <a href="{{ url_for('events') }}"> <button>Events</button></a>
      <a href="{{ url_for('chatbot') }}"><button>Chatbot</button></a>
      <button>Achievments</button>
      <button>Home</button>
      <button>Login</button>
      <button>Timeline</button>
      <!-- Admin Page Link-->
      <!-- Only after login -->
      <button>Admin</button>
    </nav>

    <!-- Carousel -->
    <section>
      <div>
        <!-- Carousel here -->
        <p>Placeholder for carousel</p>
      </div>
    </section>

    <!-- Brief intro to our webpage/subdomain -->
    <section>
      <div>
        <p>
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Eligendi
          voluptas, incidunt accusantium neque corporis voluptatem laborum error
          a quas rem maxime consequuntur voluptatibus sequi quisquam enim fuga
          perspiciatis natus. Incidunt.
        </p>
      </div>
    </section>

    <!-- Grid section -->
    <section>
      <!-- Grid goes here -->
      <div>
        <h2>Clubs</h2>
        <!-- Club boxes -->
        <h2>Departments</h2>
        <!-- Department boxes-->
      </div>
    </section>

    <!-- Footer -->
    <section>
      <div>
        <!-- RV footer here -->
        <p>Footer</p>
      </div>
    </section>
  </body>
</html>


templates/chatbot.html:
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot</title>

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='styles/chatbot.css') }}"
    />
  </head>

  <body class="chatbot-bckg">
    <!-- Chatbot section -->
    <section class="chatbot">
      <!-- <h2>Chatbot</h2> -->

      <img src="../static/images/chat-bot-img.png" alt="" />

      <!-- Use hidden to hide the audio container -->
      <audio controls autoplay hidden>
        <source
          src="data:audio/mpeg;base64,{{ speech_base64 }}"
          type="audio/mpeg"
        />
        Your browser does not support the audio element.
      </audio>

      <!-- Form -->
      <form method="POST" action="/chatbot">
        <label for="user_input"
          >Hello, I am the DTL Chatbot. How can I help you today?</label
        >
        <select name="user_input" id="user_input">
          {% for question, choices in questionnaire.items() %}
          <option value="{{ question }}" disabled selected>
            {{ question }}
          </option>
          {% for choice in choices %}
          <option value="{{ choice }}">{{ choice }}</option>
          {% endfor %} {% endfor %}
        </select>
        <button type="submit">Get Assistance</button>
      </form>

      <!-- Display user input and bot response -->
      {% if user_input %}
      <div class="conversation">
        <div class="user-message">
          <p>You: {{ user_input }}</p>
        </div>

        <div class="bot-message">
          <!-- Use hidden to hide the audio container -->
          <audio controls autoplay hidden>
            <source
              src="data:audio/mpeg;base64,{{ response_audio }}"
              type="audio/mpeg"
            />
            Your browser does not support the audio element.
          </audio>
          <p>Bot Message: {{ response_text }}</p>
          {% if redirect_link %}
          <a href="{{ redirect_link }}">{{redirect_text}}</a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </section>
  </body>
</html>


templates/events.html:
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Events</title>

    <!-- Custom JS -->
    <script src="{{url_for('static',filename='javaScript/script.js')}}"></script>
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Chela+One&display=swap"
      rel="stylesheet"
    />
    <!-- MDB -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static',filename='styles/events.css') }}"
    />
  </head>

  <body onload="playback()">
    <!-- RV logo section -->
    <section id="logo_section">
      <div class="logo">
        <img
          src="{{url_for('static', filename='Images/RVlogo.png')}}"
          alt="RV logo"
        />
      </div>
      <div class="logo_des">
        <span id="top_font">Rashtreeya Sikshana Samithi Trust</span>
        <span id="great_rv">R V College of Engineering</span>
        <span id="bottom_font"
          >Autonomous Institution affiliated to Visvesvaraya Technological
          University, Belagavi <br />
          Approved By AICTE, New Delhi, Accredited By NBA, New Delhi</span
        >
      </div>
      <div style="display: flex">
        <div><span id="since_rv">Since 1963</span></div>

        <div class="logo_right">
          <img
            src="{{url_for('static', filename='Images/RVrightLogo.jpg')}}"
            alt="RV right logo"
          />
        </div>
      </div>
    </section>

    <!-- Navbar -->
    <nav id="navbar_layout">
      <div id="nav_btn_container">
        <a href="{{ url_for('dashboard') }}">
          <button class="nav_button">Home</button></a
        >
        <button class="nav_button">Events</button>
        <button class="nav_button">Achievments</button>

        <button class="nav_button">Login</button>
        <button class="nav_button">Timeline</button>
        <!-- Admin Page Link-->
        <!-- Only after login -->
        <button class="nav_button">Admin</button>
      </div>
    </nav>

    <!-- SwitchBar -->
    {% block switchbar_section %}
    <section id="switchbar_section">
      <div id="switchbar_container">
        <a href="{{ url_for('all_in_one', category='upcoming') }}">
          <button class="switchbar_btn left_btn">Upcoming</button>
        </a>
        <a href="{{ url_for('all_in_one', category='ongoing') }}">
          <button class="switchbar_btn">Ongoing</button>
        </a>
        <a href="{{ url_for('all_in_one', category='completed') }}">
          <button class="switchbar_btn right_btn">Completed</button>
        </a>
      </div>
    </section>
    {% endblock %}

    <!-- Section Separator -->
    <div class="section_separator"></div>
    {% block genEvents %}

    <!-- Events -->
    <section>
      <div class="sub_heading">
        Welcome to the centralised event hub of RVCE
      </div>
      <div class="gen_text">
        Discover a world of captivating events organized by various clubs and
        departments at our college. Stay informed about the latest happenings
        and relive memorable past events through our comprehensive event
        notification platform. Engage in stimulating discussions, showcase your
        talents, and partake in friendly competitions. Whether you're interested
        in academic pursuits, artistic expressions, or athletic endeavors, our
        website is your gateway to a plethora of enriching experiences. Stay
        connected, get involved, and make the most of your college journey as we
        keep you updated on all the exciting events taking place on campus.
      </div>
    </section>

    <!-- Carousel -->
    <section id="carousel_section">
      <section id="type_1_carousel_3">
        <div class="firstCarousel_3">
          <img
            src="https://i.ibb.co/ykRbtKR/8thMile.jpg"
            alt="Image not found"
            id="img1_3"
          />
        </div>
        <div id="midCarousel">
          <img
            src="https://i.ibb.co/gjpCPTP/fest.jpg"
            alt="Image not found"
            id="img2_3"
          />
        </div>
        <div class="firstCarousel_3">
          <img
            src="https://i.ibb.co/nBSM2Z1/marathon.jpg"
            alt="Image not found"
            id="img3_3"
          />
        </div>
      </section>
    </section>

    <!-- Section Separator -->
    <div class="section_separator"></div>

    <!--Tech Clubs Section -->
    <section id="tech_clubs_section">
      <div class="sub_heading">Technical Clubs</div>
      <div class="addmargin row row-cols-1 row-cols-md-3 g-4">
        <div class="col">
          <div class="card">
            <img
              src="{{ url_for('static', filename='Images/ashwa.jpeg') }}"
              class="card_size_adjust card-img-top"
              alt="Hollywood Sign on The Hill"
            />
          </div>
        </div>
        <div class="col">
          <div class="card">
            <img
              src="{{ url_for('static', filename='Images/antariksh.png') }}"
              class="card_size_adjust card-img-top"
              alt="Palm Springs Road"
            />
          </div>
        </div>
        <div class="col">
          <div class="card">
            <img
              src="https://i.ibb.co/MSydPXZ/coding.png"
              class="card_size_adjust card-img-top"
              alt="Los Angeles Skyscrapers"
            />
          </div>
        </div>
        <div class="col">
          <div class="card">
            <img
              src="https://i.ibb.co/XspXyJC/ham.jpg"
              class="card_size_adjust card-img-top"
              alt="Skyscrapers"
            />
          </div>
        </div>
      </div>
    </section>

    <!-- Section Separator -->
    <div class="section_separator"></div>

    <!-- Cultural Clubs Section -->
    <section id="cultural_clubs_section">
      <div class="sub_heading">Culutral Clubs</div>
      <div class="addmargin row row-cols-1 row-cols-md-3 g-4">
        <div class="col">
          <div class="card">
            <img
              src="{{ url_for('static', filename='Images/evoke.jpeg') }}"
              class="card_size_adjust card-img-top"
              alt="Hollywood Sign on The Hill"
            />
          </div>
        </div>
        <div class="col">
          <div class="card">
            <img
              src="{{ url_for('static', filename='Images/rotaract.png') }}"
              class="card_size_adjust card-img-top"
              alt="Palm Springs Road"
            />
          </div>
        </div>
        <div class="col">
          <div class="card">
            <img
              src="{{ url_for('static', filename='Images/footprints.jpeg') }}"
              class="card_size_adjust card-img-top"
              alt="Los Angeles Skyscrapers"
            />
          </div>
        </div>
        <div class="col">
          <div class="card">
            <img
              src="{{ url_for('static', filename='Images/ecell.jpeg') }}"
              class="card_size_adjust card-img-top"
              alt="Skyscrapers"
            />
          </div>
        </div>
      </div>
    </section>
    {% endblock %}

    <!-- Section Separator -->
    <div class="section_separator"></div>

    <!-- Footer -->

    <!-- MDB -->
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.js"
    ></script>
  </body>
</html>


templates/eventDetails.html:
{% extends 'events.html' %} {% block switchbar_section %}
<!-- Landing Image -->
<div class="add_img_margin_new">
  <img src="{{ image }}" class="img-fluid" alt="Wild Landscape" />
</div>
{% endblock %} {% block genEvents %}
<h1 class="sub_title_det">{{ title }}</h1>
<div class="description">
  <h2>Hosted by {{ host }}</h2>
  <img
    src="{{ url_for('static',filename='Images/pocket-watch.gif') }}"
    alt=""
    class="gif_adjust"
  />
  <h5 style="display: inline-block; text-align: center; margin-top: 20px">
    On {{ date }}
  </h5>
  <p>{{ des }}</p>
  <img
    src="{{ url_for('static',filename='Images/location.gif') }}"
    alt=""
    class="gif_adjust"
  />
  <h6 style="display: inline-block">RVCE</h6>
  <div>
    <button class="explore_button">Register</button>
  </div>
</div>

{% endblock %}


